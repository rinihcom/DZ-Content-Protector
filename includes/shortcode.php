<?php/** * Author : Budi S * Author URI: http://inef.web.id * License: GPL2 */class div_billing_shortcode{	public $wpdb;	public $table;	public $current_user;		public function __construct() {		global $wpdb,$current_user;		$this->wpdb = $wpdb;		$this->table = $wpdb->prefix.'div_billing_membership';	}		public function show_list(){		if ( !is_user_logged_in() )			die("Sorry you don't have priviledge to access this page");					$user_id = get_current_user_id();				$status_payment = $this->wpdb->get_results("SELECT * FROM ".$this->wpdb->prefix."div_billing_trans WHERE user_id='".$user_id."'");		if(count($status_payment) > 0)			wp_safe_redirect( site_url().'/paid-member' );				$results = $this->wpdb->get_results("SELECT * FROM ".$this->table);		$res_pp_sandbox = $this->wpdb->get_row("SELECT * FROM ".$this->wpdb->prefix."div_billing_settings WHERE setting_key='pp_mode'");		$res_pp_account = $this->wpdb->get_row("SELECT * FROM ".$this->wpdb->prefix."div_billing_settings WHERE setting_key='pp_account'");				if( $res_pp_sandbox->setting_value =='Live')			$paypal_url = "https://www.paypal.com/cgi-bin/webscr";		else			$paypal_url = "https://www.sandbox.paypal.com/cgi-bin/webscr";				$paypal_account = $res_pp_account->setting_value;		if( $results ): ?>			<table>			<?php foreach($results as $r): ?>				<tr>					<td>						<?php if($r->mm_duration == 0) echo 'One Time Fee';else echo $r->mm_duration.' months' ?>					</td>					<td>						<?php if($r->mm_duration == 0) : ?>							<form name="_xclick" action="<?php echo $paypal_url ?>" method="post">							<input type="hidden" name="cmd" value="_xclick">							<input type="hidden" name="business" value="<?php echo $paypal_account?>">							<input type="hidden" name="currency_code" value="USD">							<input type="hidden" name="item_name" value="One Time Fee">							<input type="hidden" name="amount" value="<?php echo $r->mm_amount ?>">							<input id="notify_url" type="hidden" name="notify_url" value="<?php echo div_billing_pluginurl().'ipn.php?userid='.$user_id ?>&payment_id=<?php echo $r->mm_id?>&amount=<?php echo $r->mm_amount ?>">							<input type="image" src="http://www.paypalobjects.com/en_US/i/btn/btn_buynow_LG.gif" border="0" name="submit" alt="Make payments with PayPal - it's fast, free and secure!">							</form>						<?php else: ?>							<form id="form_paypal_<?php echo $r->mm_id ?>" name="_xclick" action="<?php echo $paypal_url ?>" method="post">							<input type="hidden" name="cmd" value="_xclick-subscriptions">							<input type="hidden" name="business" value="<?php echo $paypal_account?>">							<input type="hidden" name="currency_code" value="USD">							<input type="hidden" name="no_shipping" value="1">							<input type="image" src="http://www.paypal.com/en_US/i/btn/btn_subscribe_LG.gif" border="0" name="submit" alt="Make payments with PayPal - it's fast, free and secure!">							<input type="hidden" name="return" value="<?php echo dite_member_fullurl() ?>">							<input id="notify_url" type="hidden" name="notify_url" value="<?php echo div_billing_pluginurl().'ipn.php?userid='.$user_id ?>&payment_id=<?php echo $r->mm_id?>&amount=<?php echo $r->mm_amount ?>">							<input type="hidden" name="a3" value="<?php echo $r->mm_amount ?>">							<input type="hidden" name="p3" value="<?php echo $r->mm_duration ?>">							<input type="hidden" name="t3" value="M">							<input type="hidden" name="src" value="1">							<input type="hidden" name="sra" value="1">							</form>						<?php endif; ?>					</td>				</tr>			<?php endforeach; ?>			</table>		<?php endif;	}		public function check_paid(){		if ( !is_user_logged_in() )			die("Sorry you don't have priviledge to access this page");					$user_id = get_current_user_id();				$status_payment = $this->wpdb->get_results("SELECT * FROM ".$this->wpdb->prefix."div_billing_trans WHERE user_id='".$user_id."'");		if(count($status_payment) < 1)			die("Sorry you don't have priviledge to access this page");	}		public function check_loggedin(){		if ( !is_user_logged_in() )			die("Sorry you don't have priviledge to access this page");	}		public function show_purchase(){		if ( !is_user_logged_in() )			die("Sorry you don't have priviledge to access this page");					$user_id = get_current_user_id();				$results = $this->wpdb->get_results("SELECT * FROM ".$this->table);		$res_pp_sandbox = $this->wpdb->get_row("SELECT * FROM ".$this->wpdb->prefix."div_billing_settings WHERE setting_key='pp_mode'");		$res_pp_account = $this->wpdb->get_row("SELECT * FROM ".$this->wpdb->prefix."div_billing_settings WHERE setting_key='pp_account'");				if( $res_pp_sandbox->setting_value =='Live')			$paypal_url = "https://www.paypal.com/cgi-bin/webscr";		else			$paypal_url = "https://www.sandbox.paypal.com/cgi-bin/webscr";				$paypal_account = $res_pp_account->setting_value;		if( $results ): ?>			<table>			<?php foreach($results as $r): ?>				<tr>					<td>						<?php if($r->mm_duration == 0) echo 'One Time Fee';else echo $r->mm_duration.' months' ?>					</td>					<td>						<?php if($r->mm_duration == 0) : ?>							<form name="_xclick" action="<?php echo $paypal_url ?>" method="post">							<input type="hidden" name="cmd" value="_xclick">							<input type="hidden" name="business" value="<?php echo $paypal_account?>">							<input type="hidden" name="currency_code" value="USD">							<input type="hidden" name="item_name" value="One Time Fee">							<input type="hidden" name="amount" value="<?php echo $r->mm_amount ?>">							<input id="notify_url" type="hidden" name="notify_url" value="<?php echo div_billing_pluginurl().'ipn.php?userid='.$user_id ?>&payment_id=<?php echo $r->mm_id?>&amount=<?php echo $r->mm_amount ?>">							<input type="image" src="http://www.paypalobjects.com/en_US/i/btn/btn_buynow_LG.gif" border="0" name="submit" alt="Make payments with PayPal - it's fast, free and secure!">							</form>						<?php else: ?>							<form id="form_paypal_<?php echo $r->mm_id ?>" name="_xclick" action="<?php echo $paypal_url ?>" method="post">							<input type="hidden" name="cmd" value="_xclick-subscriptions">							<input type="hidden" name="business" value="<?php echo $paypal_account?>">							<input type="hidden" name="currency_code" value="USD">							<input type="hidden" name="no_shipping" value="1">							<input type="image" src="http://www.paypal.com/en_US/i/btn/btn_subscribe_LG.gif" border="0" name="submit" alt="Make payments with PayPal - it's fast, free and secure!">							<input type="hidden" name="return" value="<?php echo dite_member_fullurl() ?>">							<input id="notify_url" type="hidden" name="notify_url" value="<?php echo div_billing_pluginurl().'ipn.php?userid='.$user_id ?>&payment_id=<?php echo $r->mm_id?>&amount=<?php echo $r->mm_amount ?>">							<input type="hidden" name="a3" value="<?php echo $r->mm_amount ?>">							<input type="hidden" name="p3" value="<?php echo $r->mm_duration ?>">							<input type="hidden" name="t3" value="<?php echo substr($r->mm_duration_type, 0,1); ?>">							<input type="hidden" name="src" value="1">							<input type="hidden" name="sra" value="1">							</form>						<?php endif; ?>					</td>				</tr>			<?php endforeach; ?>			</table>		<?php endif;	}	public function show_membership_purchase($id){		$show = "";		if ( !is_user_logged_in() ){			$show = "style='display:none';";			//die("Sorry you don't have priviledge to access this page");?>			<!--<a id="div_reg" href="javascript:void(0)"><img src="http://www.paypal.com/en_US/i/btn/btn_subscribe_LG.gif" /></a>-->			<script type="text/javascript">				jQuery(document).ready(function($){					$('#div_reg').click(function(){						var url = '<?php echo div_billing_pluginurl().'front-ajax.php'; ?>?action=div_billing_register_ajax_form&KeepThis=true';						url		+= '&TB_iframe=true&height=400&width=600';						//$(this).attr('href',url);						tb_show('Register',url);						//return false;					});					$('.openbox').click(function(){						var url = $(this).attr('data-href');						url		+= '&KeepThis=true&TB_iframe=true&height=400&width=600';						//$(this).attr('href',url);						tb_show( $(this).attr('title'),url);						//return false;					});				});							</script>			<?php		}		//else{					$user_id = get_current_user_id();					$results = $this->wpdb->get_row("SELECT * FROM ".$this->table." WHERE mm_id='".$id."'");			$res_pp_sandbox = $this->wpdb->get_row("SELECT * FROM ".$this->wpdb->prefix."div_billing_settings WHERE setting_key='pp_mode'");			$res_pp_account = $this->wpdb->get_row("SELECT * FROM ".$this->wpdb->prefix."div_billing_settings WHERE setting_key='pp_account'");						if( $res_pp_sandbox->setting_value =='Live')				$paypal_url = "https://www.paypal.com/cgi-bin/webscr";			else				$paypal_url = "https://www.sandbox.paypal.com/cgi-bin/webscr";						$paypal_account = $res_pp_account->setting_value;			$r=$results;			$show_pp = "BUTTON_ONLY";			include_once( div_billing_pluginpath() . 'views/register_member.php');		//}				}	public function show_register_subuser($id){		global $wpdb;		if($_POST){			if($_POST['div_action'] == 'register'){				if( !empty($_POST['log']) AND (strlen($_POST['pwd']) > 3) AND div_billing_member_verifyemail($_POST['email'])){					$login_total = $wpdb->get_row("SELECT * FROM $wpdb->users WHERE user_login = '".$_POST['log']."'");					if($login_total){						$messages[] = 'Username exists, Please choose other username';					}					else{						$email_total = $wpdb->get_row("SELECT * FROM $wpdb->users WHERE user_email = '".$_POST['email']."'");						if($email_total){							$messages[] = 'Email exists, Please choose other email';						}						else{							$user_data = array(								'ID' => '',								'user_pass' => wp_generate_password(),								'user_login' => $_POST['log'],								'display_name' => $_POST['log'],								'first_name' => $_POST['firstname'],								'last_name' => $_POST['lastname'],								'role' => 'subscriber'							);															$user_id = wp_insert_user( $user_data );							wp_set_password($_POST['pwd'], $user_id);							$ndata = array(										'subuser_id' => $_POST['subuser'],										'user_id' => $user_id									);							$wpdb->insert($wpdb->prefix.'div_billing_subuser_list', $ndata);															wp_update_user( array ('ID' => $user_id, 'user_email' => $_POST['email']) ) ;							//wp_safe_redirect( $_POST['redirect_to'] );															echo ('<div style="margin-left:20px;font-family:arial;font-size:12px;"><h3>Register Complete</h3>');							echo ('<div>Click <a href="#" class="login_link" onclick="javascript:void(0);">here</a> for login</div></div>');							//die();						}					}				}				else{					if(!div_billing_member_verifyemail($_POST['email'])) $messages[] = 'Email invalid';					else $messages[] = 'Please fill all fields correctly';				}			}		}		//echo div_billing_pluginpath().'views/register_subuser.php';		include_once( div_billing_pluginpath() . '/views/register_subuser.php' );	}}$div_billing_shortcode = new div_billing_shortcode;